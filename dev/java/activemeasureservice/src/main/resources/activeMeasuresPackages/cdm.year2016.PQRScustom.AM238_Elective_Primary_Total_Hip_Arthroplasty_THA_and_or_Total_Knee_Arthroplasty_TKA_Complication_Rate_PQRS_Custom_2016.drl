package net.ahm.activemeasure.cdm.year2016.PQRScustom.AM238_Elective_Primary_Total_Hip_Arthroplasty_THA_and_or_Total_Knee_Arthroplasty_TKA_Complication_Rate_PQRS_Custom_2016

import net.ahm.careengine.domain.member.MemberInfo
import net.ahm.careengine.domain.event.claim.ClaimHeader
import net.ahm.careengine.domain.measures.active.ActiveMeasure
import net.ahm.careengine.domain.member.ActiveMeasuresMemberInfo
import net.ahm.careengine.util.GlobalFunctions
import net.ahm.careengine.service.activemeasure.ActiveMeasureCommandOutputIF
import net.ahm.careengine.domain.member.Gender
import net.ahm.careengine.domain.measures.active.ActiveMeasure
import net.ahm.careengine.domain.member.ActiveMeasuresMemberInfo
import net.ahm.careengine.domain.measures.active.ActiveMeasureRuleContext
import net.ahm.careengine.domain.measures.active.ActiveMeasure
import net.ahm.careengine.domain.event.lab.LabEvent
import net.ahm.careengine.domain.event.proc.ProcedureEvent
import net.ahm.careengine.domain.event.diag.DiagnosticEvent
import net.ahm.careengine.domain.measures.active.impl.MemberActiveMeasure
import net.ahm.careengine.domain.event.drug.DrugEvent
import net.ahm.careengine.util.OverlappedEvents
import net.ahm.careengine.util.GlobalFunctions
import net.ahm.careengine.service.activemeasure.ActiveMeasureCommandOutputIF
import java.util.Collection
import java.util.Date
import net.ahm.careengine.domain.feedback.Feedback
import net.ahm.careengine.domain.measures.active.ActiveMeasureBuilder
import net.ahm.careengine.domain.event.claim.ClaimHeader
import net.ahm.careengine.domain.event.clinical.HieEncounter
import net.ahm.careengine.event.adt.model.DischargeDispositionStatus
import net.ahm.careengine.domain.event.pdd.PatientDerivedEvent
import net.ahm.careengine.domain.event.lab.LabResultEvent
import net.ahm.careengine.bom.clinical.HieMood
import net.ahm.careengine.ruleengine.DroolEditor
import net.ahm.careengine.ruleengine.DateTimeUnit
import net.ahm.careengine.domain.event.Event
import net.ahm.careengine.domain.event.adt.BaseAdmissionDischardTransferEvent
import org.joda.time.LocalDate
import net.ahm.careengine.domain.temporal.ContiguousDays
import net.ahm.careengine.domain.measures.active.FactLevelMeasureNumerator
import net.ahm.careengine.domain.measures.active.FactLevelMeasureDenominator
import net.ahm.careengine.domain.measures.active.FactLevelMeasureBuilder
import net.ahm.careengine.domain.classifier.Classifier
import net.ahm.careengine.domain.event.claim.ClaimLabResultInfo
import net.ahm.careengine.domain.event.claim.ClaimBaseInfo
import net.ahm.careengine.domain.event.claim.ClaimLabInfo
import net.ahm.careengine.domain.event.claim.ClaimDiagnosticInfo
import net.ahm.careengine.domain.event.claim.ClaimProcedureInfo
import net.ahm.careengine.domain.event.claim.ClaimDrugInfo

global net.ahm.careengine.domain.measures.active.FactLevelMeasureBuilder factLevelMeasureBuilder
global java.util.Date measurementEndDate
global net.ahm.careengine.domain.measures.active.ActiveMeasureBuilder activeMeasureBuilder
global java.util.Date months12BeforeMeasurementEndDate
global java.util.Date years10BeforeMeasurementEndDate
global java.util.Date years5BeforeMeasurementEndDate
global java.util.Date months24BeforeMeasurementEndDate
global java.util.Date months3BeforeMeasurementEndDate
global java.util.Date months1BeforeMeasurementEndDate
global java.util.Date measurementStartDate




















rule "AM238_DENOM"
	dialect "mvel"
	when
		 $indexAdmisson : BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9457 , $indexDischargeDate : rawEndDate != null , rawEndDate <= measurementEndDate , rawEndDate >= months12BeforeMeasurementEndDate , $indexAdmissionDate : startDate >= months12BeforeMeasurementEndDate , startDate <= measurementEndDate )
		 not (BaseAdmissionDischardTransferEvent( startDate < ( $indexAdmissionDate ) , startDate <= measurementEndDate  && >= months12BeforeMeasurementEndDate , relatedProcedureEventElements contains 9457 )) 
		$18yearsBeforeDischargeDate : java.util.Date() from GlobalFunctions.getEarlierDate($indexDischargeDate, 18, DateTimeUnit.YEAR)
		 ActiveMeasuresMemberInfo( birthDate <= ( $18yearsBeforeDischargeDate ) )
	then
		FactLevelMeasureDenominator flmDenominator= factLevelMeasureBuilder.newFactLevelMeasureDenominatorWithPrimaryFact(238, $indexAdmisson); insert(flmDenominator)
end


rule "AM238_DENOM_EXCL_DX_9458_OR_9460"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 238 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( allDiagnosticEventElements contains 9458  || contains 9460 ) from $primaryFact
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM238_DENOM_EXCL_PROC_9459_OR_9475"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 238 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9459  || contains 9475 ) from $primaryFact
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM238_DENOM_EXCL_TRANSFER_FROM_ACUTE_FACILITY"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 238 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $admissionDate : startDate) from $primaryFact
		$1dayBeforeAdmissionDate : java.util.Date() from GlobalFunctions.getEarlierDate($admissionDate, 1, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null  && >= ( $1dayBeforeAdmissionDate )  && <= ( $admissionDate ) , relatedProcedureEventElements contains 9477 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM238_DENOM_EXCL_DISCHARGE_AGAINST_ADVICE"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 238 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( dischargeDisposition == DischargeDispositionStatus.CD_07 ) from $primaryFact
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM238_DENOM_EXCL_MORE_THAN_2_PROC_TKA"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 238 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( $factID : factId != null ) from $primaryFact
		java.util.Collection( size > 2 ) from collect ( ProcedureEvent( claimInfo != null , claimInfo.claimHeaderSkey == $factID , elements contains 9457 )) 
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM238_NUM_DX_9461"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 238 , $denomAdmission : primaryOriginationFact != null )
		 $indexAdmission : BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null , $admissionDate : startDate) from $denomAdmission
		$7daysAfterIndexAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 7, DateTimeUnit.DAY)
		 DiagnosticEvent( elements contains 9461 , startDate <= ( $7daysAfterIndexAdmission )  && >= ( $admissionDate ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($indexAdmission); insert(flmNumerator);
end


rule "AM238_NUM_DX_9463_PROC_9464"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 238 , $denomAdmission : primaryOriginationFact != null )
		 $indexAdmission : BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null , $admissionDate : startDate) from $denomAdmission
		$30daysAfterIndexAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		 DiagnosticEvent( elements contains 9463 , startDate <= ( $30daysAfterIndexAdmission )  && >= ( $admissionDate ) )
		 ProcedureEvent( elements contains 9464 , startDate <= ( $30daysAfterIndexAdmission )  && >= ( $admissionDate ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($indexAdmission); insert(flmNumerator);
end


rule "AM238_NUM_DX_9465_RPOC_9466"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 238 , $denomAdmission : primaryOriginationFact != null )
		 $indexAdmission : BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null , $admissionDate : startDate) from $denomAdmission
		$90daysAfterIndexAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 90, DateTimeUnit.DAY)
		 DiagnosticEvent( elements contains 9465 , startDate <= ( $90daysAfterIndexAdmission )  && >= ( $admissionDate ) )
		 ProcedureEvent( elements contains 9466 , startDate <= ( $90daysAfterIndexAdmission )  && >= ( $admissionDate ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($indexAdmission); insert(flmNumerator);
end


rule "AM238_ENROLLMENT_MEDICAL_PLAN_NO_GAP"
	dialect "mvel"
	when
		 $fld : FactLevelMeasureDenominator( measureId == 238 )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null , $admissionDate : startDate != null ) from $fld
		$day90After : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 90, DateTimeUnit.DAY)
		MemberInfo ( $initialGapDays2 : enrolmentGapDays ); java.util.Collection( size >=  1 ) from collect ( ContiguousDays( durationInDays >=  1) from GlobalFunctions.filterWholeDays( $initialGapDays2, $admissionDate, $day90After ) )
	then
		 $fld.setEligible( false );
end




