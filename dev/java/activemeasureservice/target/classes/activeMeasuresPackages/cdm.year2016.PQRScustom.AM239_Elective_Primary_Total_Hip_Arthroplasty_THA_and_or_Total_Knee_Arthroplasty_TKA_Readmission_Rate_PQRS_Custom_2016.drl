package net.ahm.activemeasure.cdm.year2016.PQRScustom.AM239_Elective_Primary_Total_Hip_Arthroplasty_THA_and_or_Total_Knee_Arthroplasty_TKA_Readmission_Rate_PQRS_Custom_2016

import net.ahm.careengine.domain.member.MemberInfo
import net.ahm.careengine.domain.event.claim.ClaimHeader
import net.ahm.careengine.domain.measures.active.ActiveMeasure
import net.ahm.careengine.domain.member.ActiveMeasuresMemberInfo
import net.ahm.careengine.util.GlobalFunctions
import net.ahm.careengine.service.activemeasure.ActiveMeasureCommandOutputIF
import net.ahm.careengine.domain.member.Gender
import net.ahm.careengine.domain.measures.active.ActiveMeasure
import net.ahm.careengine.domain.member.ActiveMeasuresMemberInfo
import net.ahm.careengine.domain.measures.active.ActiveMeasureRuleContext
import net.ahm.careengine.domain.measures.active.ActiveMeasure
import net.ahm.careengine.domain.event.lab.LabEvent
import net.ahm.careengine.domain.event.proc.ProcedureEvent
import net.ahm.careengine.domain.event.diag.DiagnosticEvent
import net.ahm.careengine.domain.measures.active.impl.MemberActiveMeasure
import net.ahm.careengine.domain.event.drug.DrugEvent
import net.ahm.careengine.util.OverlappedEvents
import net.ahm.careengine.util.GlobalFunctions
import net.ahm.careengine.service.activemeasure.ActiveMeasureCommandOutputIF
import java.util.Collection
import java.util.Date
import net.ahm.careengine.domain.feedback.Feedback
import net.ahm.careengine.domain.measures.active.ActiveMeasureBuilder
import net.ahm.careengine.domain.event.claim.ClaimHeader
import net.ahm.careengine.domain.event.clinical.HieEncounter
import net.ahm.careengine.event.adt.model.DischargeDispositionStatus
import net.ahm.careengine.domain.event.pdd.PatientDerivedEvent
import net.ahm.careengine.domain.event.lab.LabResultEvent
import net.ahm.careengine.bom.clinical.HieMood
import net.ahm.careengine.ruleengine.DroolEditor
import net.ahm.careengine.ruleengine.DateTimeUnit
import net.ahm.careengine.domain.event.Event
import net.ahm.careengine.domain.event.adt.BaseAdmissionDischardTransferEvent
import org.joda.time.LocalDate
import net.ahm.careengine.domain.temporal.ContiguousDays
import net.ahm.careengine.domain.measures.active.FactLevelMeasureNumerator
import net.ahm.careengine.domain.measures.active.FactLevelMeasureDenominator
import net.ahm.careengine.domain.measures.active.FactLevelMeasureBuilder
import net.ahm.careengine.domain.classifier.Classifier
import net.ahm.careengine.domain.event.claim.ClaimLabResultInfo
import net.ahm.careengine.domain.event.claim.ClaimBaseInfo
import net.ahm.careengine.domain.event.claim.ClaimLabInfo
import net.ahm.careengine.domain.event.claim.ClaimDiagnosticInfo
import net.ahm.careengine.domain.event.claim.ClaimProcedureInfo
import net.ahm.careengine.domain.event.claim.ClaimDrugInfo

global net.ahm.careengine.domain.measures.active.FactLevelMeasureBuilder factLevelMeasureBuilder
global java.util.Date measurementEndDate
global net.ahm.careengine.domain.measures.active.ActiveMeasureBuilder activeMeasureBuilder
global java.util.Date months12BeforeMeasurementEndDate
global java.util.Date years10BeforeMeasurementEndDate
global java.util.Date years5BeforeMeasurementEndDate
global java.util.Date months24BeforeMeasurementEndDate
global java.util.Date months3BeforeMeasurementEndDate
global java.util.Date months1BeforeMeasurementEndDate
global java.util.Date measurementStartDate






















rule "AM239_DENOM_EXCL_READMISSION_DX_9420_9421"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 239 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $admissionDate : startDate, $dischargeDate : rawEndDate != null ) from $primaryFact
		$30daysAfter : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9477 , startDate <= ( $30daysAfter )  && >= ( $dischargeDate ) , principalDiagnosisElements contains 9421  || contains 9420 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM239_DENOM_EXCL_READMISSION_PROC_9417"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 239 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $primaryFact
		$30daysAfter : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9477  && contains 9417 , startDate <= ( $30daysAfter )  && >= ( $dischargeDate ) )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM239_DENOM_EXCL_READMISSION_DX_9276"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 239 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $primaryFact
		$30daysAfter : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9422 , startDate <= ( $30daysAfter )  && >= ( $dischargeDate ) , principalDiagnosisElements contains 9276 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM239_DENOM_EXCL_TRANSFER_FROM_ACUTE_FACILITY"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 239 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $admissionDate : startDate) from $primaryFact
		$1dayBeforeAdmissionDate : java.util.Date() from GlobalFunctions.getEarlierDate($admissionDate, 1, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null  && >= ( $1dayBeforeAdmissionDate )  && <= ( $admissionDate ) , relatedProcedureEventElements contains 9477 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM239_DENOM"
	dialect "mvel"
	when
		 $indexAdmisson : BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9457 , $indexDischargeDate : rawEndDate != null , rawEndDate <= measurementEndDate , rawEndDate >= months12BeforeMeasurementEndDate , $indexAdmissionDate : startDate >= months12BeforeMeasurementEndDate , startDate <= measurementEndDate )
		 not (BaseAdmissionDischardTransferEvent( startDate < ( $indexAdmissionDate ) , startDate <= measurementEndDate  && >= months12BeforeMeasurementEndDate , relatedProcedureEventElements contains 9457 )) 
		$18yearsBeforeDischargeDate : java.util.Date() from GlobalFunctions.getEarlierDate($indexDischargeDate, 18, DateTimeUnit.YEAR)
		 ActiveMeasuresMemberInfo( birthDate <= ( $18yearsBeforeDischargeDate ) )
	then
		FactLevelMeasureDenominator flmDenominator= factLevelMeasureBuilder.newFactLevelMeasureDenominatorWithPrimaryFact(239, $indexAdmisson); insert(flmDenominator)
end


rule "AM239_DENOM_EXCL_DISCHARGE_AGAINST_ADVICE"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 239 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( dischargeDisposition == DischargeDispositionStatus.CD_07 ) from $primaryFact
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM239_DENOM_EXCL_DX_9458_OR_9460"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 239 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( allDiagnosticEventElements contains 9458  || contains 9460 ) from $primaryFact
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM239_DENOM_EXCL_MORE_THAN_2_PROC_TKA"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 239 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( $factID : factId != null ) from $primaryFact
		java.util.Collection( size > 2 ) from collect ( ProcedureEvent( claimInfo != null , claimInfo.claimHeaderSkey == $factID , elements contains 9457 )) 
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM239_DENOM_EXCL_PROC_9459_OR_9475"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 239 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9459  || contains 9475 ) from $primaryFact
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM239_ENROLLMENT_MEDICAL_PLAN_NO_GAP"
	dialect "mvel"
	when
		 $fld : FactLevelMeasureDenominator( measureId == 239 )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null , $admissionDate : startDate != null ) from $fld
		$day90After : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 90, DateTimeUnit.DAY)
		MemberInfo ( $initialGapDays2 : enrolmentGapDays ); java.util.Collection( size >=  1 ) from collect ( ContiguousDays( durationInDays >=  1) from GlobalFunctions.filterWholeDays( $initialGapDays2, $admissionDate, $day90After ) )
	then
		 $fld.setEligible( false );
end


rule "AM239_NUM_EXCL_DIRECT_TRANSFER_DX_9292_OR_6200_IN_FIRST_STAY"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureNumerator( measureId == 239 , $primaryFact : primaryFact != null )
		 BaseAdmissionDischardTransferEvent( $directTransferAdmissionDate : startDate) from $primaryFact
		$1dayBeforeDirectTransfer : java.util.Date() from GlobalFunctions.getEarlierDate($directTransferAdmissionDate, 1, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate <= ( $directTransferAdmissionDate )  && >= ( $1dayBeforeDirectTransfer ) , principalDiagnosisElements contains 9292  || contains 6200 )
	then
		 $fln.setExcludedFromNumerator( true );
end


rule "AM239_NUM_EXCL_DIRECT_TRANSFER_DX_9292_OR_6200_IN_SECOND_STAY"
	dialect "mvel"
	when
		$fln : FactLevelMeasureNumerator( measureId == 239 , $primaryFact : primaryFact != null )
		BaseAdmissionDischardTransferEvent( principalDiagnosisElements contains 9292  || contains 6200 ) from $primaryFact
	then
		$fln.setExcludedFromNumerator( true );
end


rule "AM239_NUM_REGULAR_READMISSION_IN_30_DAYS_DX_9461_IN_READMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $reAdmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfReadmission : rawEndDate != null , allDiagnosticEventElements contains 9461 )
		$1dayAfterReAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfReadmission, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfReadmission )  && <= ( $1dayAfterReAdmission ) , relatedProcedureEventElements contains 9477 )) 
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($reAdmission); insert(flmNumerator);
end


rule "AM239_NUM_REGULAR_READMISSION_IN_30_DAYS_DX_9463_IN_READMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $reAdmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477  && contains 9464 , $dischargeDateOfReadmission : rawEndDate != null , allDiagnosticEventElements contains 9463 )
		$1dayAfterReAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfReadmission, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfReadmission )  && <= ( $1dayAfterReAdmission ) , relatedProcedureEventElements contains 9477 )) 
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($reAdmission); insert(flmNumerator);
end


rule "AM239_NUM_REGULAR_READMISSION_IN_30_DAYS_DX_9465_IN_READMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $reAdmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477  && contains 9466 , $dischargeDateOfReadmission : rawEndDate != null , allDiagnosticEventElements contains 9465 )
		$1dayAfterReAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfReadmission, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfReadmission )  && <= ( $1dayAfterReAdmission ) , relatedProcedureEventElements contains 9477 )) 
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($reAdmission); insert(flmNumerator);
end


rule "AM239_NUM_REGULAR_READMISSION_IN_30_DAYS_DX_9463_WITHIN_30DAYS_AFTER_INDEX_ADMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $reAdmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfReadmission : rawEndDate != null )
		$1dayAfterReAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfReadmission, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfReadmission )  && <= ( $1dayAfterReAdmission ) , relatedProcedureEventElements contains 9477 )) 
		 DiagnosticEvent( elements contains 9463 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
		 ProcedureEvent( elements contains 9464 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($reAdmission); insert(flmNumerator);
end


rule "AM239_NUM_REGULAR_READMISSION_IN_30_DAYS_DX_9461_WITHIN_30DAYS_AFTER_INDEX_ADMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $reAdmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfReadmission : rawEndDate != null )
		$1dayAfterReAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfReadmission, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfReadmission )  && <= ( $1dayAfterReAdmission ) , relatedProcedureEventElements contains 9477 )) 
		 DiagnosticEvent( elements contains 9461 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($reAdmission); insert(flmNumerator);
end


rule "AM239_NUM_DIRECT_TRANSFER_READMISSION_IN_30_DAYS_DX_9465_WITHIN_READMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $firstStayOfReAdmission : BaseAdmissionDischardTransferEvent( $admissionDateOfFirstStay : startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfFirstStay : rawEndDate != null  && <= measurementEndDate )
		$1dayAfterFirstStay : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfFirstStay, 1, DateTimeUnit.DAY)
		 $secondStayOfReadmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfFirstStay )  && <= ( $1dayAfterFirstStay ) , relatedProcedureEventElements contains 9477 , $dischargeDateOfReAdmission : rawEndDate != null  && <= measurementEndDate  && >= ( $Jan3 ) )
		 DiagnosticEvent( elements contains 9465 , startDate <= ( $dischargeDateOfReAdmission )  && >= ( $admissionDateOfFirstStay ) )
		 ProcedureEvent( elements contains 9466 , startDate <= ( $dischargeDateOfReAdmission )  && >= ( $admissionDateOfFirstStay ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($secondStayOfReadmission); insert(flmNumerator);
end


rule "AM239_NUM_DIRECT_TRANSFER_READMISSION_IN_30_DAYS_DX_9461_WITHIN_READMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $firstStayOfReAdmission : BaseAdmissionDischardTransferEvent( $admissionDateOfFirstStay : startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfFirstStay : rawEndDate != null  && <= measurementEndDate )
		$1dayAfterFirstStay : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfFirstStay, 1, DateTimeUnit.DAY)
		 $secondStayOfReadmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfFirstStay )  && <= ( $1dayAfterFirstStay ) , relatedProcedureEventElements contains 9477 , $dischargeDateOfReAdmission : rawEndDate != null  && <= measurementEndDate  && >= ( $Jan3 ) )
		 DiagnosticEvent( elements contains 9461 , startDate <= ( $dischargeDateOfReAdmission )  && >= ( $admissionDateOfFirstStay ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($secondStayOfReadmission); insert(flmNumerator);
end


rule "AM239_NUM_DIRECT_TRANSFER_READMISSION_IN_30_DAYS_DX_9463_WITHIN_READMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $firstStayOfReAdmission : BaseAdmissionDischardTransferEvent( $admissionDateOfFirstStay : startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfFirstStay : rawEndDate != null  && <= measurementEndDate )
		$1dayAfterFirstStay : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfFirstStay, 1, DateTimeUnit.DAY)
		 $secondStayOfReadmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfFirstStay )  && <= ( $1dayAfterFirstStay ) , relatedProcedureEventElements contains 9477 , $dischargeDateOfReAdmission : rawEndDate != null  && <= measurementEndDate  && >= ( $Jan3 ) )
		 DiagnosticEvent( elements contains 9463 , startDate <= ( $dischargeDateOfReAdmission )  && >= ( $admissionDateOfFirstStay ) )
		 ProcedureEvent( elements contains 9464 , startDate <= ( $dischargeDateOfReAdmission )  && >= ( $admissionDateOfFirstStay ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($secondStayOfReadmission); insert(flmNumerator);
end


rule "AM239_NUM_DIRECT_TRANSFER_READMISSION_IN_30_DAYS_DX_9463_WITHIN_30DAYS_AFTER_INDEX_ADMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $firstStayOfReAdmission : BaseAdmissionDischardTransferEvent( $admissionDateOfFirstStay : startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfFirstStay : rawEndDate != null  && <= measurementEndDate )
		$1dayAfterFirstStay : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfFirstStay, 1, DateTimeUnit.DAY)
		 $secondStayOfReadmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfFirstStay )  && <= ( $1dayAfterFirstStay ) , relatedProcedureEventElements contains 9477 , $dischargeDateOfReAdmission : rawEndDate != null  && <= measurementEndDate  && >= ( $Jan3 ) )
		 DiagnosticEvent( elements contains 9463 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
		 ProcedureEvent( elements contains 9464 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($secondStayOfReadmission); insert(flmNumerator);
end


rule "AM239_NUM_DIRECT_TRANSFER_READMISSION_IN_30_DAYS_DX_9461_WITHIN_30DAYS_AFTER_INDEX_ADMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $firstStayOfReAdmission : BaseAdmissionDischardTransferEvent( $admissionDateOfFirstStay : startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfFirstStay : rawEndDate != null  && <= measurementEndDate )
		$1dayAfterFirstStay : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfFirstStay, 1, DateTimeUnit.DAY)
		 $secondStayOfReadmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfFirstStay )  && <= ( $1dayAfterFirstStay ) , relatedProcedureEventElements contains 9477 , $dischargeDateOfReAdmission : rawEndDate != null  && <= measurementEndDate  && >= ( $Jan3 ) )
		 DiagnosticEvent( elements contains 9461 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($secondStayOfReadmission); insert(flmNumerator);
end


rule "AM239_NUM_DIRECT_TRANSFER_READMISSION_IN_30_DAYS_DX_9465_WITHIN_30DAYS_AFTER_INDEX_ADMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $firstStayOfReAdmission : BaseAdmissionDischardTransferEvent( $admissionDateOfFirstStay : startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfFirstStay : rawEndDate != null  && <= measurementEndDate )
		$1dayAfterFirstStay : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfFirstStay, 1, DateTimeUnit.DAY)
		 $secondStayOfReadmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfFirstStay )  && <= ( $1dayAfterFirstStay ) , relatedProcedureEventElements contains 9477 , $dischargeDateOfReAdmission : rawEndDate != null  && <= measurementEndDate  && >= ( $Jan3 ) )
		 DiagnosticEvent( elements contains 9465 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
		 ProcedureEvent( elements contains 9466 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($secondStayOfReadmission); insert(flmNumerator);
end


rule "AM239_NUM_REGULAR_READMISSION_IN_30_DAYS_DX_9465_WITHIN_30DAYS_AFTER_INDEX_ADMISSION"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 239 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $reAdmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfReadmission : rawEndDate != null )
		$1dayAfterReAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfReadmission, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfReadmission )  && <= ( $1dayAfterReAdmission ) , relatedProcedureEventElements contains 9477 )) 
		 DiagnosticEvent( elements contains 9465 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
		 ProcedureEvent( elements contains 9466 , startDate <= ( $30daysAfterDischargeDate )  && >= ( $dischargeDate ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($reAdmission); insert(flmNumerator);
end


