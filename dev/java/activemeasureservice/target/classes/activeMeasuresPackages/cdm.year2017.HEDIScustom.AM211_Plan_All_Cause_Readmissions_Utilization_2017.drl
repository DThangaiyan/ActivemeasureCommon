package net.ahm.activemeasure.cdm.year2017.HEDIScustom.AM211_Plan_All_Cause_Readmissions_Utilization_2017

import net.ahm.careengine.domain.member.MemberInfo
import net.ahm.careengine.domain.event.claim.ClaimHeader
import net.ahm.careengine.domain.measures.active.ActiveMeasure
import net.ahm.careengine.domain.member.ActiveMeasuresMemberInfo
import net.ahm.careengine.util.GlobalFunctions
import net.ahm.careengine.service.activemeasure.ActiveMeasureCommandOutputIF
import net.ahm.careengine.domain.member.Gender
import net.ahm.careengine.domain.measures.active.ActiveMeasureRuleContext
import net.ahm.careengine.domain.event.lab.LabEvent
import net.ahm.careengine.domain.event.proc.ProcedureEvent
import net.ahm.careengine.domain.event.diag.DiagnosticEvent
import net.ahm.careengine.domain.measures.active.impl.MemberActiveMeasure
import net.ahm.careengine.domain.event.drug.DrugEvent
import net.ahm.careengine.util.OverlappedEvents
import java.util.Collection
import java.util.Date
import net.ahm.careengine.domain.feedback.Feedback
import net.ahm.careengine.domain.measures.active.ActiveMeasureBuilder
import net.ahm.careengine.domain.event.clinical.HieEncounter
import net.ahm.careengine.event.adt.model.DischargeDispositionStatus
import net.ahm.careengine.domain.event.pdd.PatientDerivedEvent
import net.ahm.careengine.domain.event.lab.LabResultEvent
import net.ahm.careengine.bom.clinical.HieMood
import net.ahm.careengine.ruleengine.DroolEditor
import net.ahm.careengine.ruleengine.DateTimeUnit
import net.ahm.careengine.domain.event.Event
import net.ahm.careengine.domain.event.adt.BaseAdmissionDischardTransferEvent
import org.joda.time.LocalDate
import net.ahm.careengine.domain.temporal.ContiguousDays
import net.ahm.careengine.domain.measures.active.FactLevelMeasureNumerator
import net.ahm.careengine.domain.measures.active.FactLevelMeasureDenominator
import net.ahm.careengine.domain.measures.active.FactLevelMeasureBuilder
import net.ahm.careengine.domain.event.claim.ClaimBaseInfo
import net.ahm.careengine.domain.event.claim.ClaimDiagnosticInfo
import net.ahm.careengine.domain.classifier.Classifier
import net.ahm.careengine.domain.event.claim.ClaimLabResultInfo
import net.ahm.careengine.domain.event.claim.ClaimLabInfo
import net.ahm.careengine.domain.event.claim.ClaimProcedureInfo
import net.ahm.careengine.domain.event.claim.ClaimDrugInfo

global java.util.Date measurementEndDate
global net.ahm.careengine.domain.measures.active.ActiveMeasureBuilder activeMeasureBuilder
global java.util.Date months12BeforeMeasurementEndDate
global java.util.Date years10BeforeMeasurementEndDate
global java.util.Date years5BeforeMeasurementEndDate
global java.util.Date months24BeforeMeasurementEndDate
global net.ahm.careengine.domain.measures.active.FactLevelMeasureBuilder factLevelMeasureBuilder
global net.ahm.careengine.domain.measures.active.ActiveMeasureClassifierBuilder classifierBuilder
global java.util.Date months3BeforeMeasurementEndDate
global java.util.Date months1BeforeMeasurementEndDate
global java.util.Date measurementStartDate

















rule "AM211_DENOM_DIRECT_TRANSFER"
	dialect "mvel"
	when
		 $originalStay : BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9477 , $originalDischargeDate : rawEndDate != null , rawEndDate <= months1BeforeMeasurementEndDate , rawEndDate >= months12BeforeMeasurementEndDate )
		$1DayAfterFirstAdmission : java.util.Date() from GlobalFunctions.getLaterDate($originalDischargeDate, 1, DateTimeUnit.DAY)
		 $secondAdmission : BaseAdmissionDischardTransferEvent( startDate <= ( $1DayAfterFirstAdmission ) , startDate >= ( $originalDischargeDate ) , relatedProcedureEventElements contains 9477 , $dischargeDate : rawEndDate != null , rawEndDate <= months1BeforeMeasurementEndDate , rawEndDate >= months12BeforeMeasurementEndDate )
		$18yearsBeforeDischargeDate : java.util.Date() from GlobalFunctions.getEarlierDate($dischargeDate, 18, DateTimeUnit.YEAR)
		 ActiveMeasuresMemberInfo( birthDate <= ( $18yearsBeforeDischargeDate ) )
	then
		FactLevelMeasureDenominator flmDenominator= factLevelMeasureBuilder.newFactLevelMeasureDenominatorWithPrimaryFact(211, $secondAdmission); insert(flmDenominator)
end


rule "AM211_DENOM_EXCL_ADMISSION_DATE_SAME_AS_DISCHARGE_DATE"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 211 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( contiguousDays != null , contiguousDays.durationInDays == 1 , rawEndDate != null ) from $primaryFact
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM211_DENOM_EXCL_REGULAR_STAY_WITH_INPT_STAY_WITHIN_30_DAYS_DX_9421_OR_9420"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 211 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null , $startDate : startDate) from $primaryFact
		$1dayBeforeStay : java.util.Date() from GlobalFunctions.getEarlierDate($startDate, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9477 , rawEndDate != null , rawEndDate >= ( $1dayBeforeStay )  && <= ( $startDate ) )) 
		$30daysAfterDischarge : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate <= measurementEndDate  && >= ( $Jan3 ) , startDate <= ( $30daysAfterDischarge )  && >= ( $dischargeDate ) , principalDiagnosisElements contains 9421  || contains 9420 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM211_DENOM_EXCL_REGULAR_STAY_WITH_INPT_STAY_WITHIN_30_DAYS_PROC_9417"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 211 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null , $startDate : startDate) from $primaryFact
		$1dayBeforeStay : java.util.Date() from GlobalFunctions.getEarlierDate($startDate, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9477 , rawEndDate != null , rawEndDate >= ( $1dayBeforeStay )  && <= ( $startDate ) )) 
		$30daysAfterDischarge : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate <= measurementEndDate  && >= ( $Jan3 ) , startDate <= ( $30daysAfterDischarge )  && >= ( $dischargeDate ) , relatedProcedureEventElements contains 9417 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM211_DENOM_EXCL_REGULAR_STAY_WITH_INPT_STAY_WITHIN_30_DAYS_PROC_9422_NO_DX_9276"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 211 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $startDate : startDate, $dischargeDate : rawEndDate != null ) from $primaryFact
		$1dayBeforeStay : java.util.Date() from GlobalFunctions.getEarlierDate($startDate, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9477 , rawEndDate != null , rawEndDate >= ( $1dayBeforeStay )  && <= ( $startDate ) )) 
		$30daysAfterDischarge : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate <= measurementEndDate  && >= ( $Jan3 ) , startDate <= ( $30daysAfterDischarge )  && >= ( $dischargeDate ) , relatedProcedureEventElements contains 9422 , principalDiagnosisElements excludes 9276 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM211_DENOM_REGULAR_STAY"
	dialect "mvel"
	when
		 $admisson : BaseAdmissionDischardTransferEvent( relatedProcedureEventElements contains 9477 , $dischargeDate : rawEndDate != null , rawEndDate <= months1BeforeMeasurementEndDate , rawEndDate >= months12BeforeMeasurementEndDate , $admissionDate : startDate != null )
		$1DayAfterFirstAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( startDate <= ( $1DayAfterFirstAdmission ) , startDate >= ( $dischargeDate ) , relatedProcedureEventElements contains 9477 )) 
		$1daybeforeAdmissiondate : java.util.Date() from GlobalFunctions.getEarlierDate($admissionDate, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate >= ( $1daybeforeAdmissiondate )  && <= ( $admissionDate ) , relatedProcedureEventElements contains 9477 )) 
		$18yearsBeforeDischargeDate : java.util.Date() from GlobalFunctions.getEarlierDate($dischargeDate, 18, DateTimeUnit.YEAR)
		 ActiveMeasuresMemberInfo( birthDate <= ( $18yearsBeforeDischargeDate ) )
	then
		FactLevelMeasureDenominator flmDenominator= factLevelMeasureBuilder.newFactLevelMeasureDenominatorWithPrimaryFact(211, $admisson); insert(flmDenominator)
end


rule "AM211_DENOM_EXCL_DX_9292_OR_6200"
	dialect "mvel"
	when
		$fln : FactLevelMeasureDenominator( measureId == 211 , $primaryFact : primaryOriginationFact != null )
		BaseAdmissionDischardTransferEvent( principalDiagnosisElements contains 9292  || contains 6200 ) from $primaryFact
	then
		$fln.setExcludedFromDenominator( true );
end


rule "AM211_NUM_REGULAR_READMISSION_IN_30_DAYS"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 211 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $reAdmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfReadmission : rawEndDate != null )
		$1dayAfterReAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfReadmission, 1, DateTimeUnit.DAY)
		 not (BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDateOfReadmission )  && <= ( $1dayAfterReAdmission ) , relatedProcedureEventElements contains 9477 )) 
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($reAdmission); insert(flmNumerator);
end


rule "AM211_NUM_DIRECT_TRANSFER_READMISSION_IN_30_DAYS"
	dialect "mvel"
	when
		 $denom : FactLevelMeasureDenominator( measureId == 211 , $denomAdmission : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $dischargeDate : rawEndDate != null ) from $denomAdmission
		$30daysAfterDischargeDate : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDate, 30, DateTimeUnit.DAY)
		$Jan3 : java.util.Date() from GlobalFunctions.getLaterDate(months12BeforeMeasurementEndDate, 2, DateTimeUnit.DAY)
		 $reAdmission : BaseAdmissionDischardTransferEvent( startDate >= ( $dischargeDate ) , startDate <= ( $30daysAfterDischargeDate ) , startDate >= ( $Jan3 ) , startDate <= measurementEndDate , relatedProcedureEventElements contains 9477 , $dischargeDateOfReadmission : rawEndDate != null )
		$1dayAfterReAdmission : java.util.Date() from GlobalFunctions.getLaterDate($dischargeDateOfReadmission, 1, DateTimeUnit.DAY)
		 $directTransfer : BaseAdmissionDischardTransferEvent( startDate <= ( $1dayAfterReAdmission )  && >= ( $dischargeDateOfReadmission ) , relatedProcedureEventElements contains 9477 , rawEndDate != null , rawEndDate <= measurementEndDate  && >= ( $Jan3 ) )
	then
		FactLevelMeasureNumerator flmNumerator = $denom.createFactLevelMeasureNumeratorWithPrimaryFact($directTransfer); insert(flmNumerator);
end


rule "AM211_DENOM_EXCL_DIRECT_TRANSFER_WITH_DX_9292_OR_6200_IN_ORIGINAL_STAY"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 211 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $directTransferAdmissionDate : startDate) from $primaryFact
		$1dayBeforeDirectTransfer : java.util.Date() from GlobalFunctions.getEarlierDate($directTransferAdmissionDate, 1, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate <= ( $directTransferAdmissionDate )  && >= ( $1dayBeforeDirectTransfer ) , principalDiagnosisElements contains 9292  || contains 6200 , relatedProcedureEventElements contains 9477 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM211_NUM_EXCL_DIRECT_TRANSFER_DX_9292_OR_6200_IN_ORIGINAL_STAY"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureNumerator( measureId == 211 , $primaryFact : primaryFact != null )
		 BaseAdmissionDischardTransferEvent( $directTransferAdmissionDate : startDate) from $primaryFact
		$1dayBeforeDirectTransfer : java.util.Date() from GlobalFunctions.getEarlierDate($directTransferAdmissionDate, 1, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate <= ( $directTransferAdmissionDate )  && >= ( $1dayBeforeDirectTransfer ) , principalDiagnosisElements contains 9292  || contains 6200 , relatedProcedureEventElements contains 9477 )
	then
		 $fln.setExcludedFromNumerator( true );
end


rule "AM211_NUM_EXCL_DX_9292_OR_6200"
	dialect "mvel"
	when
		$fln : FactLevelMeasureNumerator( measureId == 211 , $primaryFact : primaryFact != null )
		BaseAdmissionDischardTransferEvent( principalDiagnosisElements contains 9292  || contains 6200 ) from $primaryFact
	then
		$fln.setExcludedFromNumerator( true );
end


rule "AM211_DENOM_EXCL_DIRECT_TRANSFER_DX_9421_OR_9420_IN_ORIGINAL_STAY"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 211 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $directTransferAdmissionDate : startDate, rawEndDate != null ) from $primaryFact
		$1dayBeforeDirectTransfer : java.util.Date() from GlobalFunctions.getEarlierDate($directTransferAdmissionDate, 1, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate <= ( $directTransferAdmissionDate )  && >= ( $1dayBeforeDirectTransfer ) , principalDiagnosisElements contains 9421  || contains 9420 , relatedProcedureEventElements contains 9477 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM211_DENOM_EXCL_DIRECT_TRANSFER_PROC_9417_IN_ORIGINAL_STAY"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 211 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $directTransferAdmissionDate : startDate, rawEndDate != null ) from $primaryFact
		$1dayBeforeDirectTransfer : java.util.Date() from GlobalFunctions.getEarlierDate($directTransferAdmissionDate, 1, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate <= ( $directTransferAdmissionDate )  && >= ( $1dayBeforeDirectTransfer ) , relatedProcedureEventElements contains 9417  && contains 9477 )
	then
		 $fln.setExcludedFromDenominator( true );
end


rule "AM211_DENOM_EXCL_DIRECT_TRANSFER_PROC_9422_WITHOUT_DX_9276_IN_ORIGINAL_STAY"
	dialect "mvel"
	when
		 $fln : FactLevelMeasureDenominator( measureId == 211 , $primaryFact : primaryOriginationFact != null )
		 BaseAdmissionDischardTransferEvent( $directTransferAdmissionDate : startDate, rawEndDate != null ) from $primaryFact
		$1dayBeforeDirectTransfer : java.util.Date() from GlobalFunctions.getEarlierDate($directTransferAdmissionDate, 1, DateTimeUnit.DAY)
		 BaseAdmissionDischardTransferEvent( rawEndDate != null , rawEndDate <= ( $directTransferAdmissionDate )  && >= ( $1dayBeforeDirectTransfer ) , relatedProcedureEventElements contains 9422  && contains 9477 , principalDiagnosisElements excludes 9276 )
	then
		 $fln.setExcludedFromDenominator( true );
end






